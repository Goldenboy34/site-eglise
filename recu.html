<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Reçu</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="topbar small">
  <div class="container topbar-inner">
    <h2>Reçu</h2>
    <a class="muted" href="home.html">← Retour</a>
  </div>
</header>

<main class="container">
  <div id="recuBox" class="card">
    <h3>Récapitulatif de votre demande</h3>
    <div id="content"></div>
    <div style="margin-top:14px">
      <button id="downloadBtn" class="btn">Télécharger le reçu (PDF)</button>
    </div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const last = JSON.parse(localStorage.getItem('lastDemande'));
if(!last){
  document.getElementById('content').innerHTML = '<p>Aucune demande trouvée.</p>';
} else {
  const html = `
  <p><strong>Demandeur :</strong> ${last.demandeur}</p>
  <p><strong>Email :</strong> ${last.userEmail}</p>
  <p><strong>Contact :</strong> ${last.contact}</p>
  <p><strong>Date :</strong> ${last.date} ${last.heure}</p>
  <p><strong>Type :</strong> ${last.type_messe}</p>
  <p><strong>Montant :</strong> ${last.montant} FCFA</p>
  <p><strong>Intention :</strong><div class="boxed" style="margin-top:6px;white-space:pre-wrap;">${last.intention}</div></p>
  ${ last.paymentCapture ? `<p><strong>Preuve:</strong><br><img src="${last.paymentCapture}" style="max-width:320px;border-radius:8px;margin-top:8px;">` : ''}
  `;
  document.getElementById('content').innerHTML = html;
}

document.getElementById('downloadBtn').addEventListener('click', function(){
  // Re-génère le PDF comme dans intentions.html (simplifié)
  const d = last;
  if(!d){ alert('Rien à télécharger'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt'});
  doc.setFontSize(18); doc.setTextColor(13,71,161);
  doc.text('Reçu - Demande de Messe', 40, 60);
  doc.setFontSize(12); doc.setTextColor(0,0,0);
  let y = 90;
  const lines = [
    `Demandeur : ${d.demandeur}`,
    `Email : ${d.userEmail}`,
    `Contact : ${d.contact}`,
    `Date souhaitée : ${d.date}`,
    `Heure : ${d.heure}`,
    `Type : ${d.type_messe}`,
    `Montant : ${d.montant} FCFA`,
    `Paiement : ${d.paye ? 'Oui' : 'Non'}`,
    ''
  ];
  lines.forEach(ln => { doc.text(ln,40,y); y+=16; });
  const split = doc.splitTextToSize('Intention : ' + d.intention, 500);
  doc.text(split, 40, y);
  y += split.length * 12 + 10;
  if(d.paymentCapture){
    const img = new Image();
    img.src = d.paymentCapture;
    img.onload = function(){
      const maxWidth = 480;
      const ratio = img.width / img.height;
      let w = Math.min(img.width, maxWidth);
      let h = w / ratio;
      if(y + h > 750){ doc.addPage(); y = 40; }
      doc.addImage(img, 'JPEG', 40, y, w, h);
      doc.save(`Reçu_${d.demandeur.replace(/\s+/g,'_')}.pdf`);
    };
  } else {
    doc.save(`Reçu_${d.demandeur.replace(/\s+/g,'_')}.pdf`);
  }
});
</script>
</body>
</html>
